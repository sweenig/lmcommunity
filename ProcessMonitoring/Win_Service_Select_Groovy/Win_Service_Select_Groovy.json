{
  "id" : 13504264,
  "description" : "Monitors state of Windows Services\n\n- It automatically erases instances that no longer match the filters applied\n- Discovers only instances set to 'Automatically' start",
  "group" : "_WeenigWare ProcessMonitoring",
  "appliesTo" : "isWindows() && Win_Service_Select.includeRegEx && Win_Service_Select.excludeRegEx",
  "technology" : "https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/win32-service",
  "tags" : "",
  "checksum" : "99383932c12460ecbfbf1d201daeb707",
  "lineageId" : "pDZ7AU1XSo2wi_8TO4LxRw",
  "name" : "Win_Service_Select_Groovy",
  "displayName" : "Services",
  "version" : 1587482617,
  "auditVersion" : 0,
  "hasMultiInstances" : true,
  "collectInterval" : 180,
  "collectMethod" : "batchscript",
  "collectorAttribute" : {
    "name" : "batchscript",
    "linuxCmdline" : "",
    "linuxScript" : "",
    "groovyScript" : "import com.santaba.agent.groovyapi.win32.WMI\n\ndef host = hostProps.get(\"system.hostname\")\n\ndef service_list = WMI.queryAll(host, \"select * from win32_Service WHERE STARTMODE = \\\"AUTO\\\"\")\n\n//Enumerations obtained from https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/win32-service and put in my preferred order so that they are in ascending severity. This allows thresholds for >= 1 3 5.\nstateEnum = [\n  \"Running\",\n  \"Start Pending\",\n  \"Stop Pending\",\n  \"Continue Pending\",\n  \"Pause Pending\",\n  \"Stopped\",\n  \"Paused\",\n  \"Unknown\"\n]\n\nstatusEnum = [\n  \"OK\",\n  \"Error\",\n  \"Degraded\",\n  \"Unknown\",\n  \"Pred Fail\",\n  \"Starting\",\n  \"Stopping\",\n  \"Service\",\n  \"Stressed\",\n  \"NonRecover\",\n  \"No Contact\",\n  \"Lost Comm\"\n]\n\nservice_list.each{\n  wildvalue = it[\"NAME\"].replaceAll(/\\=|\\:|\\\\|\\#|\\s/, '')\n  println(\"${wildvalue}.state: ${stateEnum.indexOf(it[\"STATE\"])}\")\n  println(\"${wildvalue}.status: ${statusEnum.indexOf(it[\"STATUS\"])}\")\n}\nreturn(0)",
    "scriptType" : "embed",
    "windowsCmdline" : "",
    "windowsScript" : ""
  },
  "enableAutoDiscovery" : true,
  "autoDiscoveryConfig" : {
    "persistentInstance" : false,
    "disableInstance" : false,
    "deleteInactiveInstance" : false,
    "instanceAutoGroupMethod" : "ilp",
    "instanceAutoGroupMethodParams" : "auto.runasuser",
    "scheduleInterval" : 15,
    "method" : {
      "name" : "ad_script",
      "type" : "embeded",
      "winScript" : null,
      "winCmdline" : null,
      "linuxCmdline" : null,
      "linuxScript" : null,
      "groovyScript" : "import com.santaba.agent.groovyapi.win32.WMI\n\ndef host = hostProps.get(\"system.hostname\")\n\ndef service_list = WMI.queryAll(host, \"select * from win32_Service WHERE STARTMODE = \\\"AUTO\\\"\")\n\nservice_list.each {\n  wildvalue = it[\"NAME\"].replaceAll(/\\=|\\:|\\\\|\\#|\\s/, '')\n  wildalias = it[\"DISPLAYNAME\"]\n  description = null\n  //description = it[\"CAPTION\"]  //uncomment this line to use the caption as the description (unlikely)\n  caption = it[\"DESCRIPTION\"]\n  runasuser = it[\"STARTNAME\"]\n  path = it[\"PATHNAME\"]\n    println(\"${wildvalue}##${wildalias}##${description ?: \"\"}####caption=${caption}&runasuser=${runasuser}&path=${path}\")\n}\n\nreturn(0)\n"
    },
    "filters" : [ {
      "attribute" : "##WILDALIAS##",
      "operation" : "RegexMatch",
      "value" : "##Win_Service_Select.includeRegEx##",
      "comment" : "Services to include, set as property on device."
    }, {
      "attribute" : "##WILDALIAS##",
      "operation" : "RegexNotMatch",
      "value" : "##Win_Service_Select.excludeRegEx##",
      "comment" : "Services to exclude, set as property on device."
    } ]
  },
  "dataPoints" : [ {
    "id" : 17702,
    "dataSourceId" : 13504264,
    "name" : "State",
    "description" : "",
    "alertTransitionInterval" : 1,
    "alertClearTransitionInterval" : 0,
    "type" : 2,
    "dataType" : 7,
    "maxDigits" : 4,
    "postProcessorMethod" : "namevalue",
    "postProcessorParam" : "##WILDVALUE##.state",
    "rawDataFieldName" : "output",
    "maxValue" : "1",
    "minValue" : "0",
    "userParam1" : "",
    "userParam2" : "",
    "userParam3" : "",
    "alertForNoData" : 1,
    "alertExpr" : ">= 1 5 5",
    "alertExprNote" : "",
    "alertSubject" : "",
    "alertBody" : "The Windows service ##INSTANCE## ##DSIDESCRIPTION## on ##HOST## is not running.\nThis started at ##START## - or ##DURATION## ago.",
    "enableAnomalyAlertSuppression" : ""
  }, {
    "id" : 17703,
    "dataSourceId" : 13504264,
    "name" : "Status",
    "description" : "",
    "alertTransitionInterval" : 3,
    "alertClearTransitionInterval" : 0,
    "type" : 2,
    "dataType" : 7,
    "maxDigits" : 4,
    "postProcessorMethod" : "namevalue",
    "postProcessorParam" : "##WILDVALUE##.status",
    "rawDataFieldName" : "output",
    "maxValue" : "1",
    "minValue" : "0",
    "userParam1" : "",
    "userParam2" : "",
    "userParam3" : "",
    "alertForNoData" : 1,
    "alertExpr" : "",
    "alertExprNote" : "",
    "alertSubject" : "",
    "alertBody" : "",
    "enableAnomalyAlertSuppression" : ""
  }, {
    "id" : 17704,
    "dataSourceId" : 13504264,
    "name" : "RunningStatus",
    "description" : "If service is running, alert if Status is not OK.",
    "alertTransitionInterval" : 3,
    "alertClearTransitionInterval" : 0,
    "type" : 2,
    "dataType" : 7,
    "maxDigits" : 4,
    "postProcessorMethod" : "expression",
    "postProcessorParam" : "if(eq(State,0),Status,1)",
    "rawDataFieldName" : "",
    "maxValue" : "",
    "minValue" : "",
    "userParam1" : "",
    "userParam2" : "",
    "userParam3" : "",
    "alertForNoData" : 1,
    "alertExpr" : ">= 1 1 1",
    "alertExprNote" : "",
    "alertSubject" : "",
    "alertBody" : "The windows service ##INSTANCE## ##DSIDESCRIPTION## on ##HOST## is running, but not in the OK state.\nIt may be in error, degraded or starting/stoppingstate.\nThis started at ##START## - or ##DURATION## ago.",
    "enableAnomalyAlertSuppression" : ""
  } ],
  "enableEriDiscovery" : false,
  "eriDiscoveryInterval" : -1,
  "eriDiscoveryConfig" : null
}